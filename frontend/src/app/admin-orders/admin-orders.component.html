<div class="admin-orders-container">
  <div class="admin-content">
    <div class="admin-header">
      <h2>üìã Order Management 
        <span class="badge-counter" *ngIf="badgeCount > 0">{{badgeCount}}</span>
      </h2>
      <div class="header-actions">
        <div class="order-actions">
          <button class="add-order-btn" 
                  (click)="openAddOrderModal()"
                  title="Add manual order">
            ‚ûï Add Order
          </button>
        </div>
        <div class="notification-controls">
          <button class="notification-btn" 
                  *ngIf="notificationsEnabled" 
                  (click)="refreshNotifications()"
                  title="Refresh notifications">
            üîî <span class="badge-count" *ngIf="badgeCount > 0">{{badgeCount}}</span>
          </button>
          <button class="notification-btn disabled" 
                  *ngIf="!notificationsEnabled"
                  (click)="enableNotifications()"
                  title="Enable notifications">
            üîï Enable Alerts
          </button>
        </div>
      </div>
      <div class="order-stats" *ngIf="orders.length > 0">
        <span class="stat-item">Total Orders: {{orders.length}}</span>
        <span class="stat-item">New: {{getOrdersByStatus('New').length}}</span>
        <span class="stat-item">Processing: {{getOrdersByStatus('Processing').length}}</span>
        <span class="stat-item">Delivered: {{getOrdersByStatus('Delivered').length}}</span>
      </div>
    </div>

    <!-- Notification Setup Banner -->
    <div class="notification-setup-banner" *ngIf="showNotificationSetup">
      <div class="banner-content">
        <div class="banner-icon">üì±</div>
        <div class="banner-text">
          <h3>Enable iPhone Notifications üì±</h3>
          <p>{{getNotificationHelpText()}} </p>
        </div>
        <div class="banner-actions">
          <button class="btn-primary" 
                  *ngIf="notificationPermission !== 'denied'" 
                  (click)="enableNotifications()">
            Enable Notifications
          </button>
          <button class="btn-secondary" 
                  *ngIf="notificationsEnabled" 
                  (click)="disableNotifications()">
            Disable
          </button>
          <button class="btn-text" (click)="dismissNotificationSetup()">
            ‚úï
          </button>
        </div>
      </div>
    </div>

  <div class="filters">
    <label>
      Filter by Status:
      <select [(ngModel)]="filterStatus" (change)="loadOrders()">
        <option value="">All</option>
        <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
      </select>
    </label>

    <label>
      Filter by Payment Status:
      <select [(ngModel)]="filterPaymentStatus" (change)="loadOrders()">
        <option value="">All</option>
        <option *ngFor="let ps of paymentStatuses" [value]="ps">
          {{ ps }}
        </option>
      </select>
    </label>
  </div>

  <div class="table-container">
    <div class="table-scroll-hint">üì± Swipe left to see all columns</div>
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Contact</th>
          <th>Type</th>
          <th>Address</th>
          <th>Plus Code</th>
          <th>Payment Method</th>
          <th>Food Total (‚Ç±)</th>
          <th>Delivery Fee</th>
          <th>Final Total (‚Ç±)</th>
          <th>Delivery Date</th>
          <th>Payment Status</th>
          <th>Order Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of orders">
          <td>{{ order.id }}</td>
          <td>{{ order.customer_name }}</td>
          <td>{{ order.phone }}</td>
          <td>
            <span class="delivery-type" [class.pickup]="order.delivery_option === 'pickup'">
              {{ order.delivery_option === 'pickup' ? 'üè™ Pickup' : 'üöö Delivery' }}
            </span>
          </td>
          <td>{{ order.address }}</td>
          <td>
            <span *ngIf="order.plus_code" class="plus-code">{{ order.plus_code }}</span>
            <span *ngIf="!order.plus_code" class="no-plus-code">‚Äî</span>
          </td>
          <td>{{ order.payment_method }}</td>
          <td>{{ getFoodTotal(order).toFixed(2) }}</td>
          <td>
            <div class="delivery-fee-cell" *ngIf="order.delivery_option === 'delivery'">
              <span *ngIf="order.delivery_fee_status === 'pending'" class="delivery-fee-pending">
                <button class="set-fee-btn" (click)="setDeliveryFee(order)">
                  ‚ö° Set Fee
                </button>
              </span>
              <span *ngIf="order.delivery_fee_status === 'set'" class="delivery-fee-set">
                ‚Ç±{{ order.delivery_fee.toFixed(2) }}
                <button class="edit-fee-btn" (click)="setDeliveryFee(order)" title="Edit delivery fee">
                  ‚úèÔ∏è
                </button>
              </span>
            </div>
            <div class="delivery-fee-cell" *ngIf="order.delivery_option === 'pickup'">
              <span class="not-applicable">N/A</span>
            </div>
          </td>
          <td>{{ order.total_price.toFixed(2) }}</td>
          <td>
            <input
              type="text"
              [value]="order.requested_delivery | date : 'short'"
              (change)="onDeliveryDateChange(order, $event)"
              class="delivery-date-input"
              title="Edit delivery date (MM/DD/YYYY HH:MM format)"
              placeholder="MM/DD/YYYY HH:MM"
            />
          </td>
          <td>
            <select
              [(ngModel)]="order.payment_status"
              (ngModelChange)="updatePaymentStatus(order, $event)"
            >
              <option *ngFor="let ps of paymentStatuses" [value]="ps">
                {{ ps }}
              </option>
            </select>
          </td>
          <td>
            <select
              [(ngModel)]="order.status"
              (ngModelChange)="updateStatus(order, $event)"
            >
              <option *ngFor="let s of statuses" [value]="s">
                {{ s }}
              </option>
            </select>
          </td>
          <td>
            <div class="action-buttons">
              <button 
                class="view-details-btn"
                (click)="viewOrderDetails(order)"
                [disabled]="loadingOrderDetails"
                type="button"
                title="View order details"
              >
                <span *ngIf="!loadingOrderDetails">üëÅÔ∏è View</span>
                <span *ngIf="loadingOrderDetails">‚è≥</span>
              </button>
              
              <button 
                class="delete-order-btn"
                (click)="confirmDeleteOrder(order)"
                [disabled]="loadingOrderDetails"
                type="button"
                title="Delete order"
              >
                üóëÔ∏è Delete
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

    <div *ngIf="loading" class="loading">Loading orders...</div>
    <div *ngIf="error" class="error">{{ error }}</div>
  </div>
</div>

<!-- Confirmation Modal -->
<app-confirmation-modal
  [isVisible]="showConfirmModal"
  [title]="confirmModalTitle"
  [message]="confirmModalMessage"
  confirmText="Confirm"
  cancelText="Cancel"
  confirmButtonClass="confirm-btn"
  (confirmed)="onConfirmModalConfirmed()"
  (cancelled)="onConfirmModalCancelled()">
</app-confirmation-modal>

<!-- Notification Modal -->
<app-notification-modal
  [isVisible]="showNotificationModal"
  [type]="notificationType"
  [title]="notificationTitle"
  [message]="notificationMessage"
  [details]="notificationDetails"
  [autoClose]="true"
  [autoCloseDelay]="3000"
  (closeModal)="onNotificationModalClosed()">
</app-notification-modal>

<!-- Order Details Modal -->
<app-order-details-modal
  [isVisible]="showOrderDetailsModal"
  [orderDetails]="selectedOrderDetails"
  (closeModal)="onOrderDetailsModalClosed()">
</app-order-details-modal>

<!-- Delivery Fee Modal -->
<div class="modal-overlay" *ngIf="showDeliveryFeeModal" (click)="onDeliveryFeeModalOverlayClick($event)">
  <div class="delivery-fee-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>‚ö° Set Delivery Fee</h3>
      <button class="close-btn" (click)="closeDeliveryFeeModal()" type="button">‚úï</button>
    </div>
    
    <div class="modal-body">
      <div class="order-info">
        <h4>Order #{{ selectedOrderForFee?.id }}</h4>
        <div class="customer-details">
          <p><strong>Customer:</strong> {{ selectedOrderForFee?.customer_name }}</p>
          <p><strong>Phone:</strong> {{ selectedOrderForFee?.phone }}</p>
          <p><strong>Address:</strong> {{ selectedOrderForFee?.address }}</p>
          <p *ngIf="selectedOrderForFee?.plus_code"><strong>Plus Code:</strong> {{ selectedOrderForFee?.plus_code }}</p>
        </div>
      </div>
      
      <form (ngSubmit)="submitDeliveryFee()" #deliveryFeeForm="ngForm">
        <div class="form-group">
          <label for="deliveryFeeInput">Delivery Fee (‚Ç±)</label>
          <input 
            type="number" 
            id="deliveryFeeInput"
            name="deliveryFee"
            [(ngModel)]="deliveryFeeInput" 
            min="0" 
            step="0.01" 
            required 
            class="fee-input"
            placeholder="Enter delivery fee amount"
            #deliveryFeeField="ngModel"
          >
          <div class="error-message" *ngIf="deliveryFeeField.invalid && deliveryFeeField.touched">
            Please enter a valid delivery fee amount
          </div>
        </div>
        
        <div class="button-group">
          <button type="button" class="cancel-btn" (click)="closeDeliveryFeeModal()">Cancel</button>
          <button type="submit" class="confirm-btn" [disabled]="deliveryFeeForm.invalid">Set Fee</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Manual Order Entry Modal -->
<div class="modal-overlay" *ngIf="showAddOrderModal" (click)="onAddOrderModalOverlayClick($event)">
  <div class="add-order-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>‚ûï Add Manual Order</h3>
      <button class="close-btn" (click)="closeAddOrderModal()" type="button">‚úï</button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="submitManualOrder()" #manualOrderForm="ngForm">
        <!-- Customer Information -->
        <div class="form-section">
          <h4>Customer Information</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="customerName">Customer Name *</label>
              <input 
                type="text" 
                id="customerName"
                name="customerName"
                [(ngModel)]="newOrder.customer_name" 
                required 
                class="form-input"
                placeholder="Enter customer name"
                #customerNameField="ngModel"
              >
              <div class="error-message" *ngIf="customerNameField.invalid && customerNameField.touched">
                Customer name is required
              </div>
            </div>
            
            <div class="form-group">
              <label for="customerPhone">Phone Number *</label>
              <input 
                type="tel" 
                id="customerPhone"
                name="customerPhone"
                [(ngModel)]="newOrder.phone" 
                required 
                class="form-input"
                placeholder="Enter phone number"
                #customerPhoneField="ngModel"
              >
              <div class="error-message" *ngIf="customerPhoneField.invalid && customerPhoneField.touched">
                Phone number is required
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label>Order Type *</label>
            <div class="radio-group">
              <label class="radio-option">
                <input 
                  type="radio" 
                  name="deliveryOption" 
                  value="delivery" 
                  [(ngModel)]="newOrder.delivery_option"
                  (change)="onDeliveryOptionChange()"
                >
                üöö Delivery
              </label>
              <label class="radio-option">
                <input 
                  type="radio" 
                  name="deliveryOption" 
                  value="pickup" 
                  [(ngModel)]="newOrder.delivery_option"
                  (change)="onDeliveryOptionChange()"
                >
                üè™ Pickup
              </label>
            </div>
          </div>
        </div>

        <!-- Delivery Details (only shown for delivery) -->
        <div class="form-section" *ngIf="newOrder.delivery_option === 'delivery'">
          <h4>Delivery Details</h4>
          <div class="form-group">
            <label for="deliveryAddress">Address *</label>
            <textarea 
              id="deliveryAddress"
              name="deliveryAddress"
              [(ngModel)]="newOrder.address" 
              [required]="newOrder.delivery_option === 'delivery'"
              class="form-input"
              placeholder="Enter delivery address"
              rows="3"
              #deliveryAddressField="ngModel"
            ></textarea>
            <div class="error-message" *ngIf="deliveryAddressField.invalid && deliveryAddressField.touched">
              Address is required for delivery orders
            </div>
          </div>
          
          <div class="form-group">
            <label for="plusCode">Plus Code (Optional)</label>
            <input 
              type="text" 
              id="plusCode"
              name="plusCode"
              [(ngModel)]="newOrder.plus_code" 
              class="form-input"
              placeholder="Enter Plus Code if available"
            >
          </div>
          
          <div class="form-group">
            <label for="deliveryDate">Delivery Date & Time *</label>
            <input 
              type="datetime-local" 
              id="deliveryDate"
              name="deliveryDate"
              [(ngModel)]="newOrder.requested_delivery" 
              required 
              class="form-input"
              #deliveryDateField="ngModel"
            >
            <div class="error-message" *ngIf="deliveryDateField.invalid && deliveryDateField.touched">
              Delivery date and time is required
            </div>
          </div>
        </div>

        <!-- Pickup Details (only shown for pickup) -->
        <div class="form-section" *ngIf="newOrder.delivery_option === 'pickup'">
          <h4>Pickup Details</h4>
          <div class="form-group">
            <label for="pickupDate">Pickup Date & Time *</label>
            <input 
              type="datetime-local" 
              id="pickupDate"
              name="pickupDate"
              [(ngModel)]="newOrder.requested_delivery" 
              required 
              class="form-input"
              #pickupDateField="ngModel"
            >
            <div class="error-message" *ngIf="pickupDateField.invalid && pickupDateField.touched">
              Pickup date and time is required
            </div>
          </div>
        </div>

        <!-- Menu Items Selection -->
        <div class="form-section">
          <h4>Menu Items</h4>
          <div class="menu-item-selection">
            <div class="form-row">
              <div class="form-group">
                <label for="menuItemSelect">Select Item</label>
                <select 
                  id="menuItemSelect"
                  [(ngModel)]="selectedMenuItemId" 
                  (change)="onMenuItemChange()"
                  name="menuItemSelect"
                  class="form-select"
                >
                  <option value="">Choose a menu item</option>
                  <option *ngFor="let item of menuItems" [value]="item.id">
                    {{ item.name }} - ‚Ç±{{ item.base_price.toFixed(2) }}
                  </option>
                </select>
              </div>
              
              <div class="form-group" *ngIf="selectedMenuItem">
                <label for="variantSelect">Select Variant</label>
                <select 
                  id="variantSelect"
                  [(ngModel)]="selectedVariantId" 
                  (change)="onVariantChange()"
                  name="variantSelect"
                  class="form-select"
                >
                  <option value="">Choose variant</option>
                  <option *ngFor="let variant of selectedMenuItem.variants" [value]="variant.id">
                    {{ variant.name }} - ‚Ç±{{ variant.price.toFixed(2) }}
                  </option>
                </select>
              </div>
              
              <div class="form-group" *ngIf="selectedVariant">
                <label for="quantity">Quantity</label>
                <input 
                  type="number" 
                  id="quantity"
                  [(ngModel)]="selectedQuantity" 
                  name="quantity"
                  min="1"
                  class="form-input quantity-input"
                  placeholder="1"
                >
              </div>
              
              <div class="form-group" *ngIf="selectedVariant">
                <label>&nbsp;</label>
                <button 
                  type="button" 
                  class="add-item-btn"
                  (click)="addItemToOrder()"
                  [disabled]="!selectedMenuItem || !selectedVariant || selectedQuantity < 1"
                >
                  Add Item
                </button>
              </div>
            </div>
          </div>
          
          <!-- Order Items List -->
          <div class="order-items-list" *ngIf="newOrder.items.length > 0">
            <h5>Order Items:</h5>
            <div class="order-item" *ngFor="let item of newOrder.items; let i = index">
              <div class="item-details">
                <span class="item-name">{{ item.name }}</span>
                <span class="item-variant">{{ item.variant_name }}</span>
                <span class="item-quantity">Qty: {{ item.quantity }}</span>
                <span class="item-price">‚Ç±{{ (item.price * item.quantity).toFixed(2) }}</span>
              </div>
              <button 
                type="button" 
                class="remove-item-btn"
                (click)="removeItemFromOrder(i)"
                title="Remove item"
              >
                üóëÔ∏è
              </button>
            </div>
            <div class="items-subtotal">
              <strong>Items Subtotal: ‚Ç±{{ getItemsSubtotal().toFixed(2) }}</strong>
            </div>
          </div>
        </div>

        <!-- Payment & Final Details -->
        <div class="form-section">
          <h4>Payment & Order Details</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="paymentMethod">Payment Method *</label>
              <select 
                id="paymentMethod"
                name="paymentMethod"
                [(ngModel)]="newOrder.payment_method" 
                required 
                class="form-select"
                #paymentMethodField="ngModel"
              >
                <option value="">Select payment method</option>
                <option value="Cash">Cash</option>
                <option value="GCash">GCash</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Credit Card">Credit Card</option>
              </select>
              <div class="error-message" *ngIf="paymentMethodField.invalid && paymentMethodField.touched">
                Payment method is required
              </div>
            </div>
            
            <div class="form-group" *ngIf="newOrder.delivery_option === 'delivery'">
              <label for="deliveryFee">Delivery Fee (‚Ç±)</label>
              <input 
                type="number" 
                id="deliveryFee"
                name="deliveryFee"
                [(ngModel)]="newOrder.delivery_fee" 
                min="0" 
                step="0.01" 
                class="form-input"
                placeholder="0.00"
                (input)="calculateTotal()"
              >
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="orderStatus">Order Status</label>
              <select 
                id="orderStatus"
                name="orderStatus"
                [(ngModel)]="newOrder.status" 
                class="form-select"
              >
                <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="paymentStatus">Payment Status</label>
              <select 
                id="paymentStatus"
                name="paymentStatus"
                [(ngModel)]="newOrder.payment_status" 
                class="form-select"
              >
                <option *ngFor="let status of paymentStatuses" [value]="status">{{ status }}</option>
              </select>
            </div>
          </div>
          
          <div class="total-section">
            <div class="total-breakdown">
              <div class="total-line">Items: ‚Ç±{{ getItemsSubtotal().toFixed(2) }}</div>
              <div class="total-line" *ngIf="newOrder.delivery_option === 'delivery'">
                Delivery: ‚Ç±{{ (newOrder.delivery_fee || 0).toFixed(2) }}
              </div>
              <div class="total-line total-final">
                <strong>Total: ‚Ç±{{ getFinalTotal().toFixed(2) }}</strong>
              </div>
            </div>
          </div>
        </div>
        
        <div class="button-group">
          <button type="button" class="cancel-btn" (click)="closeAddOrderModal()">Cancel</button>
          <button 
            type="submit" 
            class="confirm-btn" 
            [disabled]="manualOrderForm.invalid || newOrder.items.length === 0 || submittingOrder"
          >
            <span *ngIf="!submittingOrder">Create Order</span>
            <span *ngIf="submittingOrder">Creating...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

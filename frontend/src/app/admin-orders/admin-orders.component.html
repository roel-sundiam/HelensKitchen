<div class="admin-orders-container">
  <div class="admin-content">
    <div class="admin-header">
      <h2>üìã Order Management</h2>
      <div class="order-stats" *ngIf="orders.length > 0">
        <span class="stat-item">Total Orders: {{orders.length}}</span>
        <span class="stat-item">New: {{getOrdersByStatus('New').length}}</span>
        <span class="stat-item">Processing: {{getOrdersByStatus('Processing').length}}</span>
        <span class="stat-item">Delivered: {{getOrdersByStatus('Delivered').length}}</span>
      </div>
    </div>

  <div class="filters">
    <label>
      Filter by Status:
      <select [(ngModel)]="filterStatus" (change)="loadOrders()">
        <option value="">All</option>
        <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
      </select>
    </label>

    <label>
      Filter by Payment Status:
      <select [(ngModel)]="filterPaymentStatus" (change)="loadOrders()">
        <option value="">All</option>
        <option *ngFor="let ps of paymentStatuses" [value]="ps">
          {{ ps }}
        </option>
      </select>
    </label>
  </div>

  <div class="table-container">
    <div class="table-scroll-hint">üì± Swipe left to see all columns</div>
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Contact</th>
          <th>Type</th>
          <th>Address</th>
          <th>Plus Code</th>
          <th>Payment Method</th>
          <th>Food Total (‚Ç±)</th>
          <th>Delivery Fee</th>
          <th>Final Total (‚Ç±)</th>
          <th>Delivery Date</th>
          <th>Payment Status</th>
          <th>Order Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of orders">
          <td>{{ order.id }}</td>
          <td>{{ order.customer_name }}</td>
          <td>{{ order.phone }}</td>
          <td>
            <span class="delivery-type" [class.pickup]="order.delivery_option === 'pickup'">
              {{ order.delivery_option === 'pickup' ? 'üè™ Pickup' : 'üöö Delivery' }}
            </span>
          </td>
          <td>{{ order.address }}</td>
          <td>
            <span *ngIf="order.plus_code" class="plus-code">{{ order.plus_code }}</span>
            <span *ngIf="!order.plus_code" class="no-plus-code">‚Äî</span>
          </td>
          <td>{{ order.payment_method }}</td>
          <td>{{ getFoodTotal(order).toFixed(2) }}</td>
          <td>
            <div class="delivery-fee-cell" *ngIf="order.delivery_option === 'delivery'">
              <span *ngIf="order.delivery_fee_status === 'pending'" class="delivery-fee-pending">
                <button class="set-fee-btn" (click)="setDeliveryFee(order)">
                  ‚ö° Set Fee
                </button>
              </span>
              <span *ngIf="order.delivery_fee_status === 'set'" class="delivery-fee-set">
                ‚Ç±{{ order.delivery_fee.toFixed(2) }}
                <button class="edit-fee-btn" (click)="setDeliveryFee(order)" title="Edit delivery fee">
                  ‚úèÔ∏è
                </button>
              </span>
            </div>
            <div class="delivery-fee-cell" *ngIf="order.delivery_option === 'pickup'">
              <span class="not-applicable">N/A</span>
            </div>
          </td>
          <td>{{ order.total_price.toFixed(2) }}</td>
          <td>
            <input
              type="text"
              [value]="order.requested_delivery | date : 'short'"
              (change)="onDeliveryDateChange(order, $event)"
              class="delivery-date-input"
              title="Edit delivery date (MM/DD/YYYY HH:MM format)"
              placeholder="MM/DD/YYYY HH:MM"
            />
          </td>
          <td>
            <select
              [(ngModel)]="order.payment_status"
              (ngModelChange)="updatePaymentStatus(order, $event)"
            >
              <option *ngFor="let ps of paymentStatuses" [value]="ps">
                {{ ps }}
              </option>
            </select>
          </td>
          <td>
            <select
              [(ngModel)]="order.status"
              (ngModelChange)="updateStatus(order, $event)"
            >
              <option *ngFor="let s of statuses" [value]="s">
                {{ s }}
              </option>
            </select>
          </td>
          <td>
            <div class="action-buttons">
              <button 
                class="view-details-btn"
                (click)="viewOrderDetails(order)"
                [disabled]="loadingOrderDetails"
                type="button"
                title="View order details"
              >
                <span *ngIf="!loadingOrderDetails">üëÅÔ∏è View</span>
                <span *ngIf="loadingOrderDetails">‚è≥</span>
              </button>
              
              <button 
                class="delete-order-btn"
                (click)="confirmDeleteOrder(order)"
                [disabled]="loadingOrderDetails"
                type="button"
                title="Delete order"
              >
                üóëÔ∏è Delete
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

    <div *ngIf="loading" class="loading">Loading orders...</div>
    <div *ngIf="error" class="error">{{ error }}</div>
  </div>
</div>

<!-- Confirmation Modal -->
<app-confirmation-modal
  [isVisible]="showConfirmModal"
  [title]="confirmModalTitle"
  [message]="confirmModalMessage"
  confirmText="Confirm"
  cancelText="Cancel"
  confirmButtonClass="confirm-btn"
  (confirmed)="onConfirmModalConfirmed()"
  (cancelled)="onConfirmModalCancelled()">
</app-confirmation-modal>

<!-- Notification Modal -->
<app-notification-modal
  [isVisible]="showNotificationModal"
  [type]="notificationType"
  [title]="notificationTitle"
  [message]="notificationMessage"
  [details]="notificationDetails"
  [autoClose]="true"
  [autoCloseDelay]="3000"
  (closeModal)="onNotificationModalClosed()">
</app-notification-modal>

<!-- Order Details Modal -->
<app-order-details-modal
  [isVisible]="showOrderDetailsModal"
  [orderDetails]="selectedOrderDetails"
  (closeModal)="onOrderDetailsModalClosed()">
</app-order-details-modal>

<!-- Delivery Fee Modal -->
<div class="modal-overlay" *ngIf="showDeliveryFeeModal" (click)="onDeliveryFeeModalOverlayClick($event)">
  <div class="delivery-fee-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>‚ö° Set Delivery Fee</h3>
      <button class="close-btn" (click)="closeDeliveryFeeModal()" type="button">‚úï</button>
    </div>
    
    <div class="modal-body">
      <div class="order-info">
        <h4>Order #{{ selectedOrderForFee?.id }}</h4>
        <div class="customer-details">
          <p><strong>Customer:</strong> {{ selectedOrderForFee?.customer_name }}</p>
          <p><strong>Phone:</strong> {{ selectedOrderForFee?.phone }}</p>
          <p><strong>Address:</strong> {{ selectedOrderForFee?.address }}</p>
          <p *ngIf="selectedOrderForFee?.plus_code"><strong>Plus Code:</strong> {{ selectedOrderForFee?.plus_code }}</p>
        </div>
      </div>
      
      <form (ngSubmit)="submitDeliveryFee()" #deliveryFeeForm="ngForm">
        <div class="form-group">
          <label for="deliveryFeeInput">Delivery Fee (‚Ç±)</label>
          <input 
            type="number" 
            id="deliveryFeeInput"
            name="deliveryFee"
            [(ngModel)]="deliveryFeeInput" 
            min="0" 
            step="0.01" 
            required 
            class="fee-input"
            placeholder="Enter delivery fee amount"
            #deliveryFeeField="ngModel"
          >
          <div class="error-message" *ngIf="deliveryFeeField.invalid && deliveryFeeField.touched">
            Please enter a valid delivery fee amount
          </div>
        </div>
        
        <div class="button-group">
          <button type="button" class="cancel-btn" (click)="closeDeliveryFeeModal()">Cancel</button>
          <button type="submit" class="confirm-btn" [disabled]="deliveryFeeForm.invalid">Set Fee</button>
        </div>
      </form>
    </div>
  </div>
</div>

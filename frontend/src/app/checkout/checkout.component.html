<div class="checkout-container">
  <!-- Order Success Message -->
  <div *ngIf="orderSubmitted" class="order-success">
    <div class="success-content">
      <div class="success-icon">âœ…</div>
      <h1>Order Submitted Successfully!</h1>
      <div class="order-details">
        <h3>Order #{{orderId}}</h3>
        <p>Thank you for your order! We've received your order and will begin processing it shortly.</p>
        
        <!-- Different messages for delivery vs pickup -->
        <div *ngIf="!isPickupMode" class="delivery-instructions">
          <div class="important-notice">
            ğŸ“‹ <strong>Important:</strong> Please check your order tracking for the total fee including delivery charges.
          </div>
          <p><strong>Next Steps:</strong></p>
          <ul>
            <li>Admin will review your delivery address</li>
            <li>Delivery fee will be calculated and added to your order</li>
            <li>Check order tracking for the final total amount</li>
            <li><strong>ğŸ” Secure payment instructions will be provided in order tracking</strong></li>
            <li>Send payment using the secure instructions provided</li>
            <li>Delivery will be scheduled as requested</li>
          </ul>
        </div>
        
        <div *ngIf="isPickupMode" class="pickup-instructions">
          <p><strong>Next Steps:</strong></p>
          <ul>
            <li><strong>ğŸ” Secure payment instructions will be provided in order tracking</strong></li>
            <li>Send payment using the secure instructions provided</li>
            <li>Payment verification will be processed</li>
            <li>Pickup will be scheduled as requested</li>
            <li>We'll notify you when your order is ready</li>
          </ul>
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="primary-btn" (click)="trackOrder()">
          ğŸ“‹ Track Your Order
        </button>
        <button class="secondary-btn" (click)="goToFeedback()">
          ğŸ’¬ Leave Feedback
        </button>
        <button class="tertiary-btn" (click)="startNewOrder()">
          ğŸ›’ Place New Order
        </button>
      </div>
    </div>
  </div>

  <!-- Order Summary Section -->
  <div *ngIf="!orderSubmitted" class="order-summary">
    <h2>Order Summary</h2>
    
    <div *ngIf="cartItems.length === 0" class="empty-cart">
      <p>Your cart is empty. <a routerLink="/">Continue shopping</a></p>
    </div>
    
    <div *ngIf="cartItems.length > 0">
      <div class="order-items">
        <div *ngFor="let item of cartItems" class="order-item">
          <img [src]="item.menuItem.image_url" [alt]="item.menuItem.name" class="item-image" />
          <div class="item-details">
            <h4>{{ item.menuItem.name }}</h4>
            <p class="variant">{{ item.variant }}</p>
            <p class="quantity">Qty: {{ item.quantity }}</p>
          </div>
          <div class="item-price">
            â‚±{{ (item.price * item.quantity).toFixed(2) }}
          </div>
        </div>
      </div>
      
      <!-- Order Total Section -->
      <div class="order-total">
        <div class="total-breakdown">
          <div class="subtotal">
            Food Total: â‚±{{ getCartTotal().toFixed(2) }}
          </div>
          
          <div class="delivery-fee-section" *ngIf="!isPickupMode">
            <div class="delivery-note">
              ğŸ“‹ Delivery fee will be calculated by admin after order review
            </div>
          </div>
          
          <div class="total-final">
            <strong *ngIf="isPickupMode">Total: â‚±{{ getTotalForDisplay().toFixed(2) }}</strong>
            <strong *ngIf="!isPickupMode">Food Total: â‚±{{ getTotalForDisplay().toFixed(2) }}</strong>
            <div *ngIf="!isPickupMode" class="delivery-note-small">
              (Final total with delivery fee will be shown in order tracking)
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Form Section -->
  <div *ngIf="!orderSubmitted" class="checkout-form">
    <h2>Delivery Information</h2>
    <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()">
  <label>
    Name:
    <input formControlName="name" placeholder="Enter your full name" />
    <div
      *ngIf="
        checkoutForm.get('name')?.invalid && checkoutForm.get('name')?.touched
      "
      class="error-message"
    >
      Name is required.
    </div>
  </label>

  <label>
    Phone:
    <input formControlName="phone" placeholder="Enter your phone number" />
    <div
      *ngIf="
        checkoutForm.get('phone')?.invalid && checkoutForm.get('phone')?.touched
      "
      class="error-message"
    >
      Enter valid phone number (10-15 digits).
    </div>
  </label>

  <!-- Delivery Option Toggle -->
  <div class="delivery-option-container">
    <label class="delivery-option-label">Choose your order option:</label>
    
    <div class="delivery-toggle-group">
      <div class="toggle-option">
        <input 
          type="radio" 
          id="delivery" 
          name="deliveryOption" 
          value="delivery" 
          formControlName="deliveryOption"
          class="toggle-input"
        />
        <label for="delivery" class="toggle-label">
          <span class="toggle-icon">ğŸšš</span>
          <span class="toggle-text">Delivery</span>
          <span class="toggle-description">We'll deliver to your location</span>
        </label>
      </div>
      
      <div class="toggle-option">
        <input 
          type="radio" 
          id="pickup" 
          name="deliveryOption" 
          value="pickup" 
          formControlName="deliveryOption"
          class="toggle-input"
        />
        <label for="pickup" class="toggle-label">
          <span class="toggle-icon">ğŸª</span>
          <span class="toggle-text">Pickup at Store</span>
          <span class="toggle-description">Save on delivery fees!</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Delivery Address Section (Hidden for Pickup) -->
  <div *ngIf="!isPickupMode" class="delivery-section">
    
    <!-- Free Address Search with OpenStreetMap -->
    <label>
      Search for Address:
      <div class="search-container">
        <input 
          id="search-address-input"
          formControlName="searchAddress" 
          placeholder="Search for your delivery address..."
          class="search-input"
          autocomplete="off"
          (input)="searchAddress(($any($event.target)).value)"
        />
        <div *ngIf="isMapLoading" class="loading-indicator">
          <span>ğŸ—ºï¸ Loading Maps...</span>
        </div>
        <div *ngIf="isSearching" class="loading-indicator">
          <span>ğŸ” Searching...</span>
        </div>
      </div>
      
      <!-- Search Results Dropdown -->
      <div *ngIf="searchResults.length > 0" class="search-results">
        <div 
          *ngFor="let result of searchResults; trackBy: trackByFn" 
          class="search-result-item"
          (click)="selectSearchResult(result)"
        >
          <div class="result-icon">ğŸ“</div>
          <div class="result-text">{{ result.display_name }}</div>
        </div>
      </div>
      
      <div class="help-text">
        <small>ğŸ†“ Free address search powered by OpenStreetMap</small>
      </div>
    </label>

    <!-- Map Toggle for Mobile -->
    <div class="map-controls" *ngIf="isMobileDevice">
      <button 
        type="button" 
        class="map-toggle-btn"
        (click)="toggleMapVisibility()"
        [disabled]="isMapLoading"
      >
        {{ isMapVisible ? 'ğŸ“ Hide Map' : 'ğŸ—ºï¸ Show Map' }}
      </button>
      <button 
        type="button" 
        class="current-location-btn"
        (click)="getCurrentLocation()"
        [disabled]="isGettingLocation || isMapLoading"
      >
        {{ isGettingLocation ? 'â³ Getting Location...' : 'ğŸ“ Use Current Location' }}
      </button>
    </div>

    <!-- OpenStreetMap + Leaflet Container -->
    <div class="map-container" [class.mobile-hidden]="isMobileDevice && !isMapVisible">
      <div id="leaflet-map" class="leaflet-map"></div>
      <div class="map-overlay-controls" *ngIf="!isMobileDevice">
        <button 
          type="button" 
          class="current-location-btn"
          (click)="getCurrentLocation()"
          [disabled]="isGettingLocation || isMapLoading"
          title="Use current location"
        >
          {{ isGettingLocation ? 'â³' : 'ğŸ“' }}
        </button>
      </div>
      <div class="map-attribution">
        <small>ğŸ†“ Free maps by <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a></small>
      </div>
    </div>

    <!-- Manual Address Entry -->
    <label>
      Delivery Address:
      <textarea 
        formControlName="address" 
        placeholder="Enter or confirm your delivery address"
        class="address-textarea"
      ></textarea>
      <div
        *ngIf="
          checkoutForm.get('address')?.invalid &&
          checkoutForm.get('address')?.touched
        "
        class="error-message"
      >
        Address is required.
      </div>
    </label>

    <!-- Plus Code Input -->
    <label>
      Plus Code (Optional - Precise Location):
      <div class="plus-code-display">
        <input 
          formControlName="plusCode" 
          placeholder="Enter Plus Code (e.g., 7Q723JWC+XY) or leave blank"
          class="plus-code-input"
          maxlength="20"
        />
        <div class="help-text">
          <small>ğŸ¯ Plus Code provides precise delivery location. Right-click on Google Maps to get the complete Plus Code.</small>
        </div>
        <div 
          class="error-message" 
          *ngIf="checkoutForm.get('plusCode')?.invalid && checkoutForm.get('plusCode')?.touched"
        >
          Please enter a complete Plus Code format (e.g., 7Q723JWC+XY or G5J5+XY)
        </div>
      </div>
    </label>
    
  </div>

  <!-- Pickup Information (Shown for Pickup) -->
  <div *ngIf="isPickupMode" class="pickup-info">
    <div class="pickup-details">
      <div class="pickup-icon">ğŸª</div>
      <div class="pickup-content">
        <h3>Store Pickup Details</h3>
        <p><strong>ğŸ“ Pickup Location:</strong><br>
        Helen's Kitchen<br>
        San Fernando, Pampanga</p>
        <p><strong>ğŸ“ Contact:</strong> 09175105185</p>
        <p><strong>â° Pickup Hours:</strong><br>
        Monday - Sunday: 10:00 AM - 9:00 PM</p>
        <div class="pickup-note">
          <span class="note-icon">ğŸ’¡</span>
          <span>Please bring a valid ID and your order confirmation when picking up.</span>
        </div>
      </div>
    </div>
  </div>

  <label>
    Payment Method:
    <select formControlName="paymentMethod">
      <option value="" disabled>Select payment method</option>
      <option *ngFor="let method of paymentMethods" [value]="method">
        {{ method }}
      </option>
    </select>
    <div
      *ngIf="
        checkoutForm.get('paymentMethod')?.invalid &&
        checkoutForm.get('paymentMethod')?.touched
      "
      class="error-message"
    >
      Payment method is required.
    </div>
  </label>

  <div *ngIf="checkoutForm.get('paymentMethod')?.value">
    <p><strong>Payment Instructions:</strong></p>
    <p>{{ getPaymentInstructions() }}</p>
  </div>

  <label>
    Requested Delivery Date:
    <input type="date" formControlName="deliveryDate" />
    <div
      *ngIf="
        checkoutForm.get('deliveryDate')?.errors?.['invalidDate'] &&
        checkoutForm.get('deliveryDate')?.touched
      "
      class="error-message"
    >
      Delivery must be at least 24 hours from now.
    </div>
  </label>

  <label>
    Requested Delivery Time:
    <select formControlName="deliveryTime">
      <option value="" disabled>
        {{ getDeliveryDateValue() ? 'Select delivery time' : 'Please select a date first' }}
      </option>
      <option *ngFor="let time of getAvailableTimeSlots()" [value]="time">
        {{ formatTimeForDisplay(time) }}
      </option>
    </select>
    <div class="help-text">
      <small *ngIf="getDeliveryDateValue() && isSelectedDateWeekend()">
        ğŸŒŸ Weekend hours: 8:00 AM - 8:00 PM
      </small>
      <small *ngIf="getDeliveryDateValue() && !isSelectedDateWeekend()">
        ğŸ“… Weekday hours: 4:00 PM - 8:00 PM
      </small>
    </div>
    <div
      *ngIf="
        checkoutForm.get('deliveryTime')?.errors?.['invalidTime'] &&
        checkoutForm.get('deliveryTime')?.touched
      "
      class="error-message"
    >
      Please select a valid delivery time for the chosen date.
    </div>
    <div
      *ngIf="
        checkoutForm.get('deliveryTime')?.errors?.['invalidDateTime'] &&
        checkoutForm.get('deliveryTime')?.touched
      "
      class="error-message"
    >
      The selected date and time must be at least 24 hours from now.
    </div>
    <div
      *ngIf="
        checkoutForm.get('deliveryTime')?.invalid &&
        checkoutForm.get('deliveryTime')?.touched &&
        !checkoutForm.get('deliveryTime')?.errors?.['invalidTime'] &&
        !checkoutForm.get('deliveryTime')?.errors?.['invalidDateTime']
      "
      class="error-message"
    >
      Delivery time is required.
    </div>
  </label>


      <button type="submit" [disabled]="cartItems.length === 0 || checkoutForm.invalid">
        Submit Order
      </button>
    </form>
  </div>
</div>

<!-- Error Modal -->
<app-error-modal
  [isVisible]="showErrorModal"
  [title]="errorModalTitle"
  [message]="errorModalMessage"
  [details]="errorModalDetails"
  (closeModal)="closeErrorModal()">
</app-error-modal>

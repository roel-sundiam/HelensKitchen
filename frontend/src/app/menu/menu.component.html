<div class="menu-section">
  <div class="menu-header">
    <h1 class="menu-title">MENU</h1>
    
    <div class="welcome-section">
      <!-- Animated Background Elements -->
      <div class="animated-background">
        <!-- Floating Particles -->
        <div class="floating-particles">
          <div class="particle" *ngFor="let particle of particles; let i = index" 
               [style.left.px]="particle.x" 
               [style.top.px]="particle.y"
               [style.animation-delay.s]="particle.delay"
               [style.animation-duration.s]="particle.duration">
          </div>
        </div>
        
        <!-- Floating Food Emojis -->
        <div class="floating-emojis">
          <div class="floating-emoji" *ngFor="let emoji of floatingEmojis; let i = index"
               [style.left.%]="emoji.x"
               [style.top.%]="emoji.y"
               [style.animation-delay.s]="emoji.delay"
               [style.animation-duration.s]="emoji.duration">
            {{ emoji.icon }}
          </div>
        </div>
        
        <!-- Pulsing Light Effects -->
        <div class="light-effects">
          <div class="light-pulse light-pulse-1"></div>
          <div class="light-pulse light-pulse-2"></div>
          <div class="light-pulse light-pulse-3"></div>
        </div>
      </div>

      <div class="welcome-text-container">
        <div class="text-entrance-wrapper">
          <p class="welcome-text">
            <span class="typewriter-line bounce-in-left" [class.typing]="currentLine === 0">
              <span class="typed-text">{{ typedText[0] }}</span>
              <span class="brand-name-highlight shake-glow" *ngIf="showBrandHighlight">HELEN'S KITCHEN</span>
              <span class="typed-text">{{ typedText[1] }}</span>
              <span class="cursor pulse-cursor" *ngIf="showCursor && currentLine === 0">|</span>
            </span>
          </p>
          <p class="welcome-text slide-in-right" *ngIf="showSecondLine">
            <span class="typewriter-line" [class.typing]="currentLine === 1">
              <span class="typed-text">{{ typedText[2] }}</span>
              <span class="highlight-word bounce-highlight" *ngIf="showHighlights.burgers">burgers</span>
              <span class="typed-text">{{ typedText[3] }}</span>
              <span class="highlight-word bounce-highlight" *ngIf="showHighlights.charliechan">Korean flavors</span>
              <span class="typed-text">{{ typedText[4] }}</span>
              <span class="highlight-word bounce-highlight" *ngIf="showHighlights.korean">Charlie Chan</span>
              <span class="typed-text">{{ typedText[5] }}</span>
              <span class="cursor pulse-cursor" *ngIf="showCursor && currentLine === 1">|</span>
            </span>
          </p>
        </div>
      </div>

      <div class="order-notice-wrapper">
        <p class="order-notice pulse-notice">
          üéâ All orders require 24-hour advance notice for delivery. Order today for tomorrow's feast! üçΩÔ∏è
        </p>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-filter-section">
      <!-- Search Bar -->
      <div class="search-container">
        <input 
          type="text" 
          class="search-input"
          placeholder="Search menu items..."
          (input)="onSearchChange($event)"
          [value]="searchTerm"
          aria-label="Search menu items"
        >
        <div class="search-icon">üîç</div>
      </div>

      <!-- Category Filter -->
      <div class="category-filter">
        <button 
          *ngFor="let category of categories"
          class="category-btn"
          [class.active]="selectedCategory === category.id"
          (click)="onCategoryChange(category.id)"
          [attr.aria-pressed]="selectedCategory === category.id"
        >
          {{ category.name }}
          <span class="category-count">({{ category.count }})</span>
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading-message">Loading menu...</div>
  <div *ngIf="error" class="error-message">{{ error }}</div>


  <div class="menu-grid" *ngIf="!loading && !error">
    <div class="menu-item-card" *ngFor="let item of filteredMenuItems; let i = index">
      <div class="menu-item-image">
        <!-- Image Carousel -->
        <div class="image-carousel" *ngIf="item.images && item.images.length > 1; else singleImage">
          <div class="carousel-container">
            <div class="carousel-images" [style.transform]="'translateX(-' + (currentImageIndex[item.id] || 0) * 100 + '%)'">
              <img 
                *ngFor="let image of item.images" 
                [src]="image" 
                [alt]="item.name"
                class="carousel-image"
              />
            </div>
            
            <!-- Navigation Dots -->
            <div class="carousel-dots" *ngIf="item.images.length > 1">
              <button 
                *ngFor="let image of item.images; let idx = index"
                class="carousel-dot"
                [class.active]="idx === (currentImageIndex[item.id] || 0)"
                (click)="setCurrentImage(item.id, idx)"
              ></button>
            </div>
            
            <!-- Navigation Arrows -->
            <button 
              class="carousel-arrow carousel-arrow-left"
              (click)="previousImage(item.id, item.images.length)"
              *ngIf="item.images.length > 1"
            >
              ‚Äπ
            </button>
            <button 
              class="carousel-arrow carousel-arrow-right"
              (click)="nextImage(item.id, item.images.length)"
              *ngIf="item.images.length > 1"
            >
              ‚Ä∫
            </button>
          </div>
        </div>
        
        <!-- Single Image Template -->
        <ng-template #singleImage>
          <img [src]="item.images?.[0] || item.image_url" [alt]="item.name" class="single-image" />
        </ng-template>
      </div>

      <div class="menu-item-content">
        <!-- Chef's Recommendation Badge -->
        <div class="chef-recommendation-badge" *ngIf="item.isChefRecommendation">
          <span class="chef-icon">üë®‚Äçüç≥</span>
          <span class="badge-text">HELEN'S FAVORITE</span>
        </div>
        
        <h2 class="item-name">{{ item.name }}</h2>
        <p class="item-description">{{ item.description }}</p>

        <!-- Item metadata -->
        <div class="item-metadata">
          <div class="dietary-info">
            <span 
              *ngFor="let dietary of getDietaryInfo(item.name)"
              class="dietary-badge"
              [class]="'dietary-' + dietary"
              [title]="dietary"
            >
              <span *ngIf="dietary === 'vegetarian'">üå±</span>
              <span *ngIf="dietary === 'spicy'">üå∂Ô∏è</span>
            </span>
          </div>
          <div class="prep-time">
            <span class="time-icon">‚è±Ô∏è</span>
            <span class="time-text">{{ getEstimatedTime(item.name) }}</span>
          </div>
        </div>

        <div *ngIf="item.variants && item.variants.length > 0" class="variants">
          <div *ngFor="let variant of item.variants" class="variant-option">
            <label>
              <input
                type="radio"
                [name]="'variant_' + item.id"
                [value]="variant.id"
                (change)="selectedVariants[item.id] = variant"
                [attr.aria-label]="'Select ' + variant.name + ' for ' + variant.price + ' pesos'"
              />
              <span class="variant-text">{{ variant.name }}</span>
              <span class="variant-price">‚Ç±{{ variant.price.toFixed(2) }}</span>
            </label>
          </div>
        </div>

        <div
          *ngIf="!item.variants || item.variants.length === 0"
          class="item-price"
        >
          ‚Ç±{{ item.base_price.toFixed(2) }}
        </div>

        <!-- Quantity Selector -->
        <div class="quantity-selector" *ngIf="!item.variants || item.variants.length === 0 || selectedVariants[item.id]">
          <label for="quantity_{{item.id}}" class="quantity-label">Quantity:</label>
          <div class="quantity-controls">
            <button 
              type="button"
              class="quantity-btn"
              (click)="decrementQuantity(item.id)"
              [disabled]="quantities[item.id] <= 1"
              aria-label="Decrease quantity"
            >
              ‚àí
            </button>
            <input 
              type="number" 
              id="quantity_{{item.id}}"
              class="quantity-input"
              [value]="quantities[item.id] || 1"
              (input)="quantities[item.id] = +$any($event.target).value"
              min="1"
              max="99"
              aria-label="Quantity"
            >
            <button 
              type="button"
              class="quantity-btn"
              (click)="incrementQuantity(item.id)"
              [disabled]="quantities[item.id] >= 99"
              aria-label="Increase quantity"
            >
              +
            </button>
          </div>
        </div>

        <button
          class="add-to-cart-btn"
          (click)="addItemToCart(item)"
          [disabled]="
            item.variants &&
            item.variants.length > 0 &&
            !selectedVariants[item.id]
          "
          [attr.aria-label]="'Add ' + item.name + ' to cart'"
        >
          Add to Cart
          <span *ngIf="quantities[item.id] > 1" class="quantity-badge">
            ({{ quantities[item.id] }})
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Add to Cart Modal -->
  <app-add-to-cart-modal
    [isVisible]="showModal"
    [itemName]="modalData.itemName"
    [variant]="modalData.variant"
    [price]="modalData.price"
    [itemImage]="modalData.itemImage"
    [cartCount]="cartItemCount"
    (closeModal)="closeModal()"
    (continueShopping)="onContinueShopping()"
    (viewCart)="onViewCart()">
  </app-add-to-cart-modal>

  <!-- Customer Feedback Section - Moved Below Menu -->
  <div class="feedback-section" *ngIf="feedbackStats && feedbackStats.total_reviews > 0">
    <div class="feedback-header">
      <h2 class="feedback-title">What Our Customers Say</h2>
      <div class="overall-rating-summary">
        <div class="rating-stars">{{ getStarDisplay(feedbackStats.average_rating) }}</div>
        <div class="rating-info">
          <span class="rating-number">{{ feedbackStats.average_rating }}/5</span>
          <span class="review-count">from {{ feedbackStats.total_reviews }}+ happy customers</span>
        </div>
      </div>
    </div>

    <!-- Customer Testimonial -->
    <div class="testimonial-showcase" *ngIf="getCurrentTestimonial()">
      <div class="testimonial-card">
        <div class="testimonial-quote">"{{ getCurrentTestimonial()?.comment }}"</div>
        <div class="testimonial-author">
          <span class="author-name">{{ getCurrentTestimonial()?.customer_name }}</span>
          <span class="testimonial-stars">{{ getStarDisplay(getCurrentTestimonial()?.rating || 5) }}</span>
          <span class="testimonial-time">{{ formatTimeAgo(getCurrentTestimonial()?.days_ago || 0) }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
